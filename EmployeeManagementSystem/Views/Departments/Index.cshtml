@model IEnumerable<EmployeeManagement.Application.ViewModels.DepartmentViewModel>

@{
    ViewData["Title"] = "Departments";
}

<h1>Departments</h1>

<p>
    <a href="javascript:;" class="btn btn-primary btn-create">Create New</a>
</p>
<div id="modal-placeholder"></div>

<div class="card">
    <div class="card-header">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name..." value="@ViewBag.SearchTerm" />
                    <button type="button" id="searchBtn" class="btn btn-outline-secondary">Search</button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <table class="table table-striped" id="departmentsTable">
            <thead>
                <tr>
                    <th>Department Name</th>
                    <th>Employee Count</th>
                    <th>Total Salary</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="departmentTableBody">
                @foreach (var item in Model)
                {
                    <tr data-id="@item.Id">
                        <td>@Html.DisplayFor(modelItem => item.Name)</td>
                        <td>@Html.DisplayFor(modelItem => item.EmployeeCount)</td>
                        <td>@item.TotalSalary.ToString("C")</td>
                        <td>
                            <a href="javascript:;" class="btn btn-sm btn-outline-primary btn-edit" data-id="@item.Id">Edit</a>
                            <a href="javascript:;" class="btn btn-sm btn-outline-danger btn-delete" data-id="@item.Id">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let departmentTable;

            // Initialize DataTable
            if (!$.fn.DataTable.isDataTable('#departmentsTable')) {
                departmentTable = $('#departmentsTable').DataTable({
                    paging: true,
                    ordering: true,
                    info: true,
                    searching: false,
                    lengthChange: true,
                    destroy: true,
                    columnDefs: [
                        { orderable: false, targets: [3] }, // Disable ordering for Actions column
                        { searchable: false, targets: [3] }  // Disable searching for Actions column
                    ]
                });
            } else {
                departmentTable = $('#departmentsTable').DataTable();
            }

            // Search functionality
            $('#searchBtn').on('click', function() {
                performSearch();
            });

            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    performSearch();
                }
            });

            function performSearch() {
                const searchTerm = $('#searchInput').val();
                window.location.href = `/Departments?searchTerm=${encodeURIComponent(searchTerm)}`;
            }

            // Create Department Modal
            $('body').on('click', '.btn-create', function () {
                $.get('/Departments/CreateModal')
                    .done(function (html) {
                        $('#modal-placeholder').html(html);
                        $('#modal-placeholder .modal').modal('show');
                    })
                    .fail(function (xhr) {
                        console.error("Failed to load create modal:", xhr.responseText);
                    });
            });

            // Submit Create Form
            $('body').on('submit', '#createForm', function (e) {
                e.preventDefault();
                $.post('/Departments/CreateModal', $(this).serialize())
                    .done(function (response) {
                        if (response.success) {
                            $('.modal').modal('hide');
                            $('.modal-backdrop').remove();

                            const dept = response.department;
                            // Add new row to DataTable
                            departmentTable.row.add([
                                dept.name,
                                dept.employeeCount,
                                dept.totalSalary,
                                `<a href="javascript:;" class="btn btn-sm btn-outline-primary btn-edit" data-id="${dept.id}">Edit</a>
                                 <a href="javascript:;" class="btn btn-sm btn-outline-danger btn-delete" data-id="${dept.id}">Delete</a>`
                            ]).draw(false);
                        } else {
                            $('#modal-placeholder').html(response);
                            $('#modal-placeholder .modal').modal('show');
                        }
                    })
                    .fail(function (xhr) {
                        console.error("Create error:", xhr.responseText);
                    });
            });



            // Edit Department Modal
            $('body').on('click', '.btn-edit', function () {
                const id = $(this).data('id');
                $.get(`/Departments/EditModal/${id}`)
                    .done(function (html) {
                        $('#modal-placeholder').html(html);
                        $('#modal-placeholder .modal').modal('show');
                    })
                    .fail(function (xhr) {
                        console.error("Failed to load edit modal:", xhr.responseText);
                    });
            });

            // Submit Edit Form
            $('body').on('submit', '#editForm', function (e) {
                e.preventDefault();
                $.post('/Departments/EditModal', $(this).serialize())
                    .done(function (response) {
                        if (response.success) {
                            $('.modal').modal('hide');
                            $('.modal-backdrop').remove();

                            const dept = response.department;
                            const row = $(`.btn-edit[data-id='${dept.id}']`).closest('tr');

                            // Update row in DataTable
                            departmentTable.row(row).data([
                                dept.name,
                                dept.employeeCount,
                                dept.totalSalary,
                                `<a href="javascript:;" class="btn btn-sm btn-outline-primary btn-edit" data-id="${dept.id}">Edit</a>
                                 <a href="javascript:;" class="btn btn-sm btn-outline-danger btn-delete" data-id="${dept.id}">Delete</a>`
                            ]).draw(false);
                        } else {
                            $('#modal-placeholder').html(response);
                            $('#modal-placeholder .modal').modal('show');
                        }
                    })
                    .fail(function (xhr) {
                        console.error("Edit error:", xhr.responseText);
                    });
            });

            // Delete Department Modal
            $('body').on('click', '.btn-delete', function () {
                const id = $(this).data('id');
                $.get(`/Departments/DeleteModal/${id}`)
                    .done(function (html) {
                        $('#modal-placeholder').html(html);
                        $('#modal-placeholder .modal').modal('show');
                    })
                    .fail(function (xhr) {
                        console.error("Failed to load delete modal:", xhr.responseText);
                    });
            });

            // Submit Delete Form
            $('body').on('submit', '#deleteForm', function (e) {
                e.preventDefault();
                const id = $('#Id').val();
                const row = $(`.btn-delete[data-id='${id}']`).closest('tr');

                $.post('/Departments/DeleteModal', $(this).serialize())
                    .done(function (response) {
                        if (response.success) {
                            $('.modal').modal('hide');
                            $('.modal-backdrop').remove();
                            departmentTable.row(row).remove().draw(false);
                        } else {
                            alert(response.message || 'Failed to delete department');
                        }
                    })
                    .fail(function (xhr) {
                        console.error("Delete error:", xhr.responseText);
                        alert('Failed to delete department. Please try again.');
                    });
            });
        });
    </script>
}

